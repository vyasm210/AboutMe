(function(){"use strict";TS.registerModule("attachment_actions",{action_triggered_sig:new signals.Signal,action_completed_sig:new signals.Signal,onStart:function(){TS.attachment_actions.action_triggered_sig.add(_onActionTriggered);TS.attachment_actions.action_completed_sig.add(_onActionCompleted)},getActionContext:function(args){if(!args)return;var message=TS.utility.msgs.findMsg(args.message_ts,args.channel_id);if(!message)return;var attachment=_.find(message.attachments,{id:args.attachment_id});if(!attachment)return;var action=_.find(attachment.actions,{id:args.action_id});if(!action)return;return{action:action,attachment:attachment,channel_id:args.channel_id,message:message}},getPendingAttachment:function(attachment,actions){if(!attachment||!actions||!actions.length)return;var changed_ids=_.map(actions,"id");var pending_attachment=_.cloneDeep(attachment);pending_attachment.actions.forEach(function(action){action._disabled=true;action._loading=_.includes(changed_ids,action.id)});pending_attachment._pending=true;return pending_attachment},confirmAction:function(action,callback){var confirm_class=action.style=="danger"?"btn_danger":"btn_primary";var config=_.defaults(action.confirm,{dismiss_text:"Cancel",ok_text:"OK",text:"",title:""});if(config.text){config.text=TS.emoji.graphicReplace(config.text)}else if(!config.title){config.text="Are you sure?"}if(config.title){config.title=TS.emoji.graphicReplace(config.title)}TS.generic_dialog.start({title:config.title,body:config.text,show_go_button:true,show_cancel_button:true,go_button_text:config.ok_text,go_button_class:confirm_class,cancel_button_text:config.dismiss_text,onGo:callback})},render:function(attachment,message_ts,only_render_if_pending){if(!attachment||!message_ts)return;var $container=_getAttachmentActionsContainer(attachment,message_ts);if(!$container.length)return;if(!only_render_if_pending||$container.find(".attachment_actions_buttons").hasClass("attachment_pending")){var html=TS.templates.attachment_actions({attachment:attachment});$container.html(html)}}});function _onActionTriggered(data){if(!data||!data.message||!data.attachment||!data.action||!data.channel_id){TS.warn("_onActionTriggered: missing message, attachment, action, or channel_id");return}var pending_attachment=TS.attachment_actions.getPendingAttachment(data.attachment,[data.action]);if(pending_attachment){TS.attachment_actions.render(pending_attachment,data.message.ts)}var api_args={payload:JSON.stringify({actions:[data.action],attachment_id:data.attachment.id,callback_id:data.attachment.callback_id,channel_id:data.channel_id,is_ephemeral:data.message.is_ephemeral,message_ts:data.message.ts})};if(data.message.bot_id)api_args.service_id=data.message.bot_id;if(data.message.user)api_args.bot_user_id=data.message.user;TS.api.call("chat.attachmentAction",api_args).then(function(res){TS.attachment_actions.action_completed_sig.dispatch({attachment:data.attachment,message_ts:data.message.ts,channel_id:data.channel_id,is_expecting_ms_update:!!(_.get(res,"data.replaced")||_.get(res,"data.deleted"))})}).catch(function(err){TS.error(err);TS.attachment_actions.action_completed_sig.dispatch({attachment:data.attachment,message_ts:data.message.ts,channel_id:data.channel_id,err:err})})}function _onActionCompleted(args){if(!args)return;if(args.err){var ephemeral_msg={text:_.get(args,"err.data.response")||"Oh no, something went wrong. Please try that again.",ephemeral_type:_.get(args,"err.data.error")||"attachment_action_error"};if(TS.boot_data.feature_slackbot_feels){ephemeral_msg.slackbot_feels="sad_surprise"}TS.client.ui.addEphemeralBotMsg(ephemeral_msg)}if(args.attachment&&args.message_ts&&args.channel_id&&!args.is_expecting_ms_update){_waitThenRevertActions(args)}}function _waitThenRevertActions(args){TS.utility.rAF(function(){var current_attachment=TS.utility.attachments.findAttachment({attachment_id:args.attachment.id,message_ts:args.message_ts,channel_id:args.channel_id});if(current_attachment){TS.attachment_actions.render(current_attachment,args.message_ts,true)}})}function _getAttachmentActionsContainer(attachment,message_ts){var msg_dom_id=TS.templates.makeMsgDomId(message_ts);return $("#"+msg_dom_id).find("[data-attachment-id="+attachment.id+"] .attachment_actions")}})();
